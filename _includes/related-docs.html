{% if page.collection == 'docs' %}
  <div class="uk-margin-large-top">
    <h3>{{ site.data.translation[site.lang].related_docs | default: "Related Docs" }}</h3>

    {% assign maxRelated = 5 %}
    {% assign minCommonTags = 2 %}
    {% assign maxRelatedCounter = 0 %}
    {% assign genericTags = 'doc,cloud,server,datacenter,field-creation' | split: ',' %}
    
    {% comment %} First, try to find docs from same product (by key) with smart prioritization {% endcomment %}
    {% if page.key %}
      {% assign sameProductDocs = site.docs | where: "key", page.key | where_exp: "doc", "doc.url != page.url" %}
      {% if sameProductDocs.size > 0 %}
        {% comment %} Prioritize docs from same section/category {% endcomment %}
        {% assign currentPath = page.path | split: "/" %}
        {% assign prioritizedDocs = '' | split: '' %}
        {% assign otherDocs = '' | split: '' %}
        
        {% for doc in sameProductDocs %}
          {% assign docPath = doc.path | split: "/" %}
          {% if currentPath[1] == docPath[1] %}
            {% assign prioritizedDocs = prioritizedDocs | push: doc %}
          {% else %}
            {% assign otherDocs = otherDocs | push: doc %}
          {% endif %}
        {% endfor %}
        
        {% assign allSameProductDocs = prioritizedDocs | concat: otherDocs %}
        
        <ul class="uk-list link-secondary">
        {% for doc in allSameProductDocs limit: maxRelated %}
          <li><a href="{{ doc.url | relative_url }}">{{ doc.title }}</a></li>
          {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
        {% endfor %}
        </ul>
      {% endif %}
    {% endif %}
    
    {% comment %} If not enough same-product docs, find docs with meaningful common tags {% endcomment %}
    {% if maxRelatedCounter < maxRelated and page.tags and page.tags.size > 0 %}
      {% assign remainingSlots = maxRelated | minus: maxRelatedCounter %}
      {% assign relatedDocs = '' | split: '' %}
      
      {% for doc in site.docs %}
        {% if doc.url != page.url and doc.key != page.key %}
          {% assign meaningfulTagCount = 0 %}
          
          {% comment %} Count only meaningful tags (exclude generic ones) {% endcomment %}
          {% for tag in doc.tags %}
            {% unless genericTags contains tag %}
              {% if page.tags contains tag %}
                {% assign meaningfulTagCount = meaningfulTagCount | plus: 1 %}
              {% endif %}
            {% endunless %}
          {% endfor %}

          {% if meaningfulTagCount >= minCommonTags %}
            {% assign relatedDocs = relatedDocs | push: doc %}
          {% endif %}
        {% endif %}
      {% endfor %}
      
      {% if relatedDocs.size > 0 %}
        {% unless maxRelatedCounter > 0 %}
          <ul class="uk-list link-secondary">
        {% endunless %}
        {% for doc in relatedDocs limit: remainingSlots %}
          <li><a href="{{ doc.url | relative_url }}">{{ doc.title }}</a></li>
          {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
        {% endfor %}
        {% if maxRelatedCounter > 0 %}
          </ul>
        {% endif %}
      {% endif %}
    {% endif %}
    
    {% comment %} If still not enough docs, show popular docs from other products {% endcomment %}
    {% if maxRelatedCounter < maxRelated %}
      {% assign remainingSlots = maxRelated | minus: maxRelatedCounter %}
      {% assign popularPages = 'overview,install,get-started,create-field' | split: ',' %}
      {% assign popularDocs = '' | split: '' %}
      
      {% for doc in site.docs %}
        {% if doc.url != page.url and doc.key != page.key %}
          {% assign docName = doc.path | split: "/" | last | replace: ".md", "" %}
          {% if popularPages contains docName %}
            {% assign popularDocs = popularDocs | push: doc %}
          {% endif %}
        {% endif %}
      {% endfor %}
      
      {% if popularDocs.size > 0 %}
        {% unless maxRelatedCounter > 0 %}
          <ul class="uk-list link-secondary">
        {% endunless %}
        {% for doc in popularDocs limit: remainingSlots %}
          <li><a href="{{ doc.url | relative_url }}">{{ doc.title }}</a> <span class="uk-text-muted uk-text-small">({{ doc.key | capitalize | replace: "-", " " }})</span></li>
        {% endfor %}
        {% if maxRelatedCounter > 0 or popularDocs.size > 0 %}
          </ul>
        {% endif %}
      {% endif %}
    {% endif %}
  </div>
{% endif %}
